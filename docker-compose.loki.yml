# =============================================================================
# Docker Compose for Grafana Loki - Lightweight Log Aggregation
# =============================================================================
#
# Grafana Loki is a lightweight alternative to Graylog that uses only
# 300-500MB RAM compared to Graylog's 4GB+ requirement.
#
# IMPORTANT: Coexistence with Monitoring Stack
#   This Loki stack can run alongside docker-compose.monitoring.yml
#   - Monitoring Grafana (metrics): Port 3000, container: notehub-grafana
#   - Loki Grafana (logs): Port 3001, container: grafana-loki
#   - Both stacks are independent and don't conflict
#
# Prerequisites:
#   1. Docker and Docker Compose installed
#   2. At least 512MB RAM available for Loki stack
#   3. .env.loki configuration file (optional, uses defaults)
#
# Quick Setup:
#   1. Run: docker compose -f docker-compose.loki.yml up -d
#   2. Access Grafana UI: http://your-server:3001 (admin/admin)
#   3. Send logs to Loki: http://your-server:3100
#
# Services:
#   - loki: Log aggregation server (port 3100)
#   - promtail: Log collector agent (collects from /var/log and Docker)
#   - grafana-loki: Web UI for log visualization (port 3001)
#
# Architecture:
#   Applications → Promtail → Loki → Grafana (visualization)
#
# Port Allocation:
#   - 3100: Loki server
#   - 3001: Grafana Loki UI (changed from 3000 to avoid conflicts)
#
# =============================================================================

services:
  # ==========================================================================
  # Loki - Log Aggregation Server
  # ==========================================================================
  loki:
    image: grafana/loki:2.9.3
    container_name: loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    volumes:
      - ./docker/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - loki-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # Promtail - Log Collector Agent
  # ==========================================================================
  promtail:
    image: grafana/promtail:2.9.3
    container_name: promtail
    restart: unless-stopped
    volumes:
      - ./docker/loki/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - loki-network
    depends_on:
      loki:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

  # ==========================================================================
  # Grafana - Visualization UI (Loki)
  # ==========================================================================
  # Note: This is a separate Grafana instance dedicated to Loki logs
  # It runs on port 3001 to avoid conflicts with the monitoring Grafana (port 3000)
  grafana-loki:
    image: grafana/grafana:10.2.2
    container_name: grafana-loki
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${LOKI_GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${LOKI_GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=${GRAFANA_INSTALL_PLUGINS:-}
      - GF_SERVER_ROOT_URL=${LOKI_GRAFANA_ROOT_URL:-http://localhost:3001}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-loki-data:/var/lib/grafana
      - ./docker/loki/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    networks:
      - loki-network
    depends_on:
      loki:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.notehub.description=Grafana Loki log visualization"

networks:
  loki-network:
    name: loki-network
    driver: bridge

volumes:
  loki-data:
    driver: local
  grafana-loki-data:
    driver: local
