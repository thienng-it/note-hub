# =============================================================================
# Docker Compose for NoteHub - Full Stack Deployment
# =============================================================================
#
# Deploy NoteHub on any VPS (Hetzner, DigitalOcean, etc.)
#
# Quick Start:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d
#   3. Access via http://YOUR_SERVER_IP
#
# Services:
#   - frontend: React SPA served by nginx (port 80)
#   - backend: Flask API with Gunicorn (internal port 5000)
#   - mysql: MySQL 8.0 database (internal port 3306)
#
# =============================================================================

services:
  # ==========================================================================
  # Frontend - React SPA with nginx
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Flask API with Gunicorn
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: notehub-backend
    restart: unless-stopped
    environment:
      # Flask Configuration
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:-change-me}

      # Database - SQLite (default) or MySQL
      - NOTES_DB_PATH=${NOTES_DB_PATH:-/app/data/notes.db}
      
      # MySQL Database (optional - uncomment to use MySQL)
      # - MYSQL_HOST=mysql
      # - MYSQL_PORT=3306
      # - MYSQL_USER=${MYSQL_USER}
      # - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}

      # CAPTCHA
      - CAPTCHA_TYPE=${CAPTCHA_TYPE:-simple}
    volumes:
      - notehub-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Database (Optional - for production with MySQL)
  # ==========================================================================
  # mysql:
  #   image: mysql:8.0
  #   container_name: notehub-mysql
  #   restart: unless-stopped
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
  #     - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
  #     - MYSQL_USER=${MYSQL_USER}
  #     - MYSQL_PASSWORD=${MYSQL_PASSWORD}
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  #   networks:
  #     - notehub-network

networks:
  notehub-network:
    driver: bridge

volumes:
  notehub-data:
    driver: local
  # mysql-data:
  #   driver: local
