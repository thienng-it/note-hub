# =============================================================================
# Docker Compose for NoteHub - Full Stack Deployment
# =============================================================================
#
# Deploy NoteHub on any VPS (Hetzner, DigitalOcean, etc.)
#
# Quick Start:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d
#   3. Access via http://YOUR_SERVER_IP
#
# With MySQL (optional):
#   1. Uncomment the mysql service below
#   2. Set MYSQL_* environment variables in backend
#   3. Run: docker compose --profile mysql up -d
#
# Database Seeding:
#   docker compose exec backend python scripts/seed_db.py
#
# Services:
#   - frontend: React SPA served by nginx (port 80)
#   - backend: Flask API with Gunicorn (internal port 5000)
#   - mysql: MySQL 8.0 database (optional, internal port 3306)
#
# =============================================================================

services:
  # ==========================================================================
  # Frontend - React SPA with nginx
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Flask API with Gunicorn
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: notehub-backend
    restart: unless-stopped
    environment:
      # Flask Configuration
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:-admin123456789}

      # Database - SQLite (default)
      - NOTES_DB_PATH=${NOTES_DB_PATH:-/app/data/notes.db}

      # CAPTCHA
      - CAPTCHA_TYPE=${CAPTCHA_TYPE:-simple}
    volumes:
      - notehub-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - notehub-network

  # ==========================================================================
  # Backend with MySQL - Flask API with Gunicorn (use --profile mysql)
  # ==========================================================================
  backend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: notehub-backend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    environment:
      # Flask Configuration
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:-admin123456789}

      # MySQL Database Configuration
      # IMPORTANT: Use container name 'mysql' not 'localhost'
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-notehub}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-notehub_password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}

      # CAPTCHA
      - CAPTCHA_TYPE=${CAPTCHA_TYPE:-simple}
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Database (use --profile mysql)
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: notehub-mysql
    restart: unless-stopped
    profiles:
      - mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
      - MYSQL_USER=${MYSQL_USER:-notehub}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-notehub_password}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # Frontend with MySQL Backend (use --profile mysql)
  # ==========================================================================
  frontend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    ports:
      - "80:80"
    depends_on:
      backend-mysql:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  notehub-network:
    driver: bridge

volumes:
  notehub-data:
    driver: local
  mysql-data:
    driver: local
