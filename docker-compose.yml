# =============================================================================
# Docker Compose for NoteHub - Full Stack Deployment
# =============================================================================
#
# Deploy NoteHub on any VPS (Hetzner, DigitalOcean, etc.)
#
# Development Mode (default - uses SQLite with local data):
#   docker compose up -d
#   docker compose exec backend node scripts/seed_db.js
#
# Production Mode (uses environment variables for cloud DB):
#   docker compose --profile production up -d
#   # Do NOT run seed script - use pre-configured cloud database
#
# With MySQL (development):
#   docker compose --profile mysql up -d
#   docker compose exec backend-mysql node scripts/seed_db.js
#
# Services:
#   - frontend: React SPA served by nginx (port 80)
#   - backend: Node.js/Express API (internal port 5000)
#   - mysql: MySQL 8.0 database (optional, internal port 3306)
#
# Environment Modes:
#   - NODE_ENV=development: Local SQLite, seeding allowed
#   - NODE_ENV=production: Cloud DB URL, seeding blocked
#
# =============================================================================

services:
  # ==========================================================================
  # Frontend - React SPA with nginx (Development)
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Node.js/Express API (Development - SQLite)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend
    restart: unless-stopped
    environment:
      # Development mode (allows seeding)
      - NODE_ENV=development
      
      # JWT Configuration
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # Database - SQLite (default for development)
      - NOTES_DB_PATH=${NOTES_DB_PATH:-/app/data/notes.db}
    volumes:
      - notehub-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - notehub-network

  # ==========================================================================
  # Frontend - React SPA with nginx (Production)
  # ==========================================================================
  frontend-prod:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-}
    container_name: notehub-frontend-prod
    restart: unless-stopped
    profiles:
      - production
    ports:
      - "80:80"
    depends_on:
      backend-prod:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Node.js/Express API (Production - Cloud DB)
  # ==========================================================================
  backend-prod:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-prod
    restart: unless-stopped
    profiles:
      - production
    environment:
      # Production mode (blocks seeding)
      - NODE_ENV=production
      
      # JWT Configuration (REQUIRED: use strong secret in production)
      - JWT_SECRET=${SECRET_KEY:?Set SECRET_KEY in .env file for production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # Database URL for cloud DB (MySQL/PostgreSQL)
      # Example: mysql://user:pass@host:3306/database
      - DATABASE_URL=${DATABASE_URL:-}
      
      # OR separate MySQL config
      - MYSQL_HOST=${MYSQL_HOST:-}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - notehub-network

  # ==========================================================================
  # Backend with MySQL - Node.js/Express API (use --profile mysql)
  # ==========================================================================
  backend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    environment:
      # Development mode (allows seeding)
      - NODE_ENV=development
      
      # JWT Configuration
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # MySQL Database Configuration
      # IMPORTANT: Use container name 'mysql' not 'localhost'
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Database (use --profile mysql)
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: notehub-mysql
    restart: unless-stopped
    profiles:
      - mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # Frontend with MySQL Backend (use --profile mysql)
  # ==========================================================================
  frontend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    ports:
      - "80:80"
    depends_on:
      backend-mysql:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Frontend with SSL/TLS - nginx with Let's Encrypt (use --profile ssl)
  # ==========================================================================
  nginx-ssl:
    build:
      context: .
      dockerfile: Dockerfile.frontend.ssl
      args:
        - VITE_API_URL=
        - DOMAIN=${DOMAIN}
    container_name: notehub-nginx-ssl
    restart: unless-stopped
    profiles:
      - ssl
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/certbot/conf:/etc/letsencrypt:ro
      - ./docker/certbot/www:/var/www/certbot:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - notehub-network
    # Reload nginx every 6 hours to pick up renewed certificates from Certbot
    # Standard pattern for Let's Encrypt certificate renewal
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Certbot - Let's Encrypt SSL Certificate Management (use --profile ssl)
  # ==========================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: notehub-certbot
    restart: unless-stopped
    profiles:
      - ssl
    volumes:
      - ./docker/certbot/conf:/etc/letsencrypt
      - ./docker/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - notehub-network

networks:
  notehub-network:
    driver: bridge

volumes:
  notehub-data:
    driver: local
  mysql-data:
    driver: local
