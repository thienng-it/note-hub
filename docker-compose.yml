# =============================================================================
# Docker Compose for NoteHub - Full Stack Deployment
# =============================================================================
#
# Deploy NoteHub on any VPS (Hetzner, DigitalOcean, etc.)
#
# IMPORTANT: Environment Configuration
# All services use efficient .env file loading via 'env_file' directive.
# This automatically loads ALL variables from .env, avoiding duplication.
# Critical variables are explicitly defined in 'environment' section with
# validation (e.g., :?) to ensure they are set.
#
# Setup:
#   1. Copy .env.example to .env:  cp .env.example .env
#   2. Edit .env with your configuration
#   3. Run docker compose as shown below
#
# Development Mode (default - uses SQLite with local data):
#   docker compose up -d
#   docker compose exec backend node scripts/seed_db.js
#
# Production Mode (uses environment variables for cloud DB):
#   docker compose --profile production up -d
#   # Do NOT run seed script - use pre-configured cloud database
#
# With MySQL (development):
#   docker compose --profile mysql up -d
#   docker compose exec backend-mysql node scripts/seed_db.js
#
# Services:
#   - frontend: React SPA served by nginx (port 80)
#   - backend: Node.js/Express API (internal port 5000)
#   - mysql: MySQL 8.0 database (optional, internal port 3306)
#
# Environment Modes:
#   - NODE_ENV=development: Local SQLite, seeding allowed
#   - NODE_ENV=production: Cloud DB URL, seeding blocked
#
# =============================================================================

services:
  # ==========================================================================
  # Frontend - React SPA with nginx (Development)
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Node.js/Express API (Development - SQLite)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Development mode (allows seeding)
      - NODE_ENV=development

      # JWT Configuration
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # Database - SQLite (default for development)
      - NOTES_DB_PATH=${NOTES_DB_PATH:-/app/data/notes.db}

      # OAuth Configuration (REQUIRED: set in .env file)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:?Set GOOGLE_CLIENT_ID in .env file}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:?Set GOOGLE_CLIENT_SECRET in .env file}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:?Set GOOGLE_REDIRECT_URI in .env file}

      # AI Configuration (REQUIRED: set in .env file)
      - AI_PROVIDER=${AI_PROVIDER:?Set AI_PROVIDER in .env file}
      - OLLAMA_URL=${OLLAMA_URL:?Set OLLAMA_URL in .env file}
      - OLLAMA_MODEL=${OLLAMA_MODEL:?Set OLLAMA_MODEL in .env file}
    volumes:
      - notehub-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - notehub-network

  # ==========================================================================
  # Frontend - React SPA with nginx (Production)
  # ==========================================================================
  frontend-prod:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-}
    container_name: notehub-frontend-prod
    restart: unless-stopped
    profiles:
      - production
    env_file:
      - .env
    ports:
      - "80:80"
    depends_on:
      backend-prod:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Backend - Node.js/Express API (Production - Cloud DB)
  # ==========================================================================
  backend-prod:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-prod
    restart: unless-stopped
    profiles:
      - production
    env_file:
      - .env
    environment:
      # Production mode (blocks seeding)
      - NODE_ENV=production

      # JWT Configuration (REQUIRED: use strong secret in production)
      - JWT_SECRET=${SECRET_KEY:?Set SECRET_KEY in .env file for production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # Database URL for cloud DB (MySQL/PostgreSQL)
      # Example: mysql://user:pass@host:3306/database
      - DATABASE_URL=${DATABASE_URL:-}

      # OR separate MySQL config
      - MYSQL_HOST=${MYSQL_HOST:-}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-}

      # OAuth Configuration (REQUIRED: set in .env file)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:?Set GOOGLE_CLIENT_ID in .env file}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:?Set GOOGLE_CLIENT_SECRET in .env file}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:?Set GOOGLE_REDIRECT_URI in .env file}

      # AI Configuration (REQUIRED: set in .env file)
      - AI_PROVIDER=${AI_PROVIDER:?Set AI_PROVIDER in .env file}
      - OLLAMA_URL=${OLLAMA_URL:?Set OLLAMA_URL in .env file}
      - OLLAMA_MODEL=${OLLAMA_MODEL:?Set OLLAMA_MODEL in .env file}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - notehub-network

  # ==========================================================================
  # Backend with MySQL - Node.js/Express API (use --profile mysql)
  # ==========================================================================
  backend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    env_file:
      - .env
    environment:
      # Development mode (allows seeding)
      - NODE_ENV=development

      # JWT Configuration
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000

      # Admin Credentials (REQUIRED: set in .env file)
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}

      # MySQL Database Configuration
      # IMPORTANT: Use container name 'mysql' not 'localhost'
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}

      # OAuth Configuration (REQUIRED: set in .env file)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:?Set GOOGLE_CLIENT_ID in .env file}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:?Set GOOGLE_CLIENT_SECRET in .env file}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:?Set GOOGLE_REDIRECT_URI in .env file}

      # AI Configuration (REQUIRED: set in .env file)
      - AI_PROVIDER=${AI_PROVIDER:?Set AI_PROVIDER in .env file}
      - OLLAMA_URL=${OLLAMA_URL:?Set OLLAMA_URL in .env file}
      - OLLAMA_MODEL=${OLLAMA_MODEL:?Set OLLAMA_MODEL in .env file}
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Database (use --profile mysql)
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: notehub-mysql
    restart: unless-stopped
    profiles:
      - mysql
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # Frontend with MySQL Backend (use --profile mysql)
  # ==========================================================================
  frontend-mysql:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
    container_name: notehub-frontend-mysql
    restart: unless-stopped
    profiles:
      - mysql
    env_file:
      - .env
    ports:
      - "80:80"
    depends_on:
      backend-mysql:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  notehub-network:
    driver: bridge

volumes:
  notehub-data:
    driver: local
  mysql-data:
    driver: local
