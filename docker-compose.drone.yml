# =============================================================================
# Docker Compose for Drone CI - Continuous Integration Platform with Traefik
# =============================================================================
#
# IMPORTANT: Drone CI is COMPLETELY INDEPENDENT
# 
# This is a standalone application that:
# - Does NOT depend on NoteHub or any other application
# - Can be deployed on the same server, different server, or alone
# - Uses its own services, configuration, network, and data storage
# - Can be started, stopped, moved, or removed independently
#
# When deployed on the same server as NoteHub:
#   - NoteHub uses port 80 (Traefik + frontend)
#   - Drone uses port 8080 (Traefik proxy) - NO CONFLICTS
#   - Separate networks: notehub-network vs drone-network
#   - Separate configurations: .env vs .env.drone
#   - Separate data volumes: completely isolated
#
# Prerequisites (INDEPENDENT):
#   1. Docker and Docker Compose installed
#   2. GitHub OAuth App for Drone CI authentication (separate from any other apps)
#   3. .env.drone configuration file (completely independent from .env)
#
# Quick Setup:
#   1. Copy .env.drone.example to .env.drone:  cp .env.drone.example .env.drone
#   2. Edit .env.drone with your GitHub OAuth credentials (see below)
#   3. Generate a shared secret: openssl rand -hex 16
#   4. For custom domain: Set DRONE_ROUTER_RULE=Host(`your-domain`) in .env.drone
#   5. Run docker compose: docker compose --env-file .env.drone -f docker-compose.drone.yml up -d
#
# ⚠️  IMPORTANT for Custom Domains:
#   If using a custom domain (production), you MUST set DRONE_ROUTER_RULE in .env.drone:
#   DRONE_ROUTER_RULE=Host(`drone.yourdomain.com`)
#   
#   Without this, Traefik will generate certificates for ANY domain that accesses
#   your server, causing certificate conflicts with other services like NoteHub.
#
# GitHub OAuth Setup (INDEPENDENT):
#   1. Go to https://github.com/settings/developers
#   2. Create NEW OAuth App specifically for Drone CI
#   3. Set callback URL: http://your-server:8080/login
#   4. Copy Client ID and Secret to .env.drone
#   Note: This is SEPARATE from any other GitHub OAuth apps you may have
#
# Services:
#   - drone-traefik: Traefik reverse proxy (port 8080)
#   - drone-server: Drone CI server with web UI (internal)
#   - drone-runner: Docker-based pipeline runner (internal)
#   - drone-db: PostgreSQL database for Drone (internal port 5432)
#
# Access:
#   - Drone CI UI: http://your-server:8080
#   - NoteHub UI:  http://your-server (port 80)
#
# Architecture:
#   Both Drone and NoteHub use Traefik as reverse proxy for consistency.
#   - NoteHub: Traefik (port 80) → frontend + backend
#   - Drone CI: Traefik (port 8080) → drone-server
#   This provides consistent architecture, SSL termination, caching, and compression.
#
# =============================================================================

services:
  # ==========================================================================
  # Traefik - Reverse Proxy for Drone CI with SSL/HTTPS
  # ==========================================================================
  drone-traefik:
    image: traefik:v2.11
    container_name: drone-traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=drone-network"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--ping=true"
    ports:
      # External port 8080 for HTTP and 8443 for HTTPS to avoid conflict with NoteHub (ports 80/443)
      - "8080:80"
      - "8443:443"
    environment:
      - ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/drone-dynamic.yml:/etc/traefik/dynamic/dynamic.yml:ro
      - ./letsencrypt-drone:/letsencrypt
    depends_on:
      drone-server:
        condition: service_healthy
    networks:
      - drone-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Drone Server - Main API and Web UI (Internal)
  # ==========================================================================
  drone-server:
    image: drone/drone:2
    container_name: drone-server
    restart: unless-stopped
    env_file:
      - .env.drone
    environment:
      # Database Configuration
      - DRONE_DATABASE_DRIVER=postgres
      - DRONE_DATABASE_DATASOURCE=postgres://${DRONE_POSTGRES_USER:-drone}:${DRONE_POSTGRES_PASSWORD}@drone-db:5432/${DRONE_POSTGRES_DB:-drone}?sslmode=disable
      
      # User Configuration
      - DRONE_USER_CREATE=${DRONE_USER_CREATE:-}
      
      # Optional: Registration Mode
      - DRONE_REGISTRATION_CLOSED=${DRONE_REGISTRATION_CLOSED:-false}
      
      # Optional: Logs
      - DRONE_LOGS_DEBUG=${DRONE_LOGS_DEBUG:-false}
      - DRONE_LOGS_TRACE=${DRONE_LOGS_TRACE:-false}
    # No exposed ports - accessed via Traefik reverse proxy
    volumes:
      - drone-data:/data
    depends_on:
      drone-db:
        condition: service_healthy
    networks:
      - drone-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      
      # Route traffic to drone-server
      # Set DRONE_ROUTER_RULE in .env.drone to control routing:
      #   - Host(`domain`) for custom domains (prevents certificate conflicts)
      #   - PathPrefix(`/`) for localhost/IP access (default)
      - "traefik.http.routers.drone-server.rule=${DRONE_ROUTER_RULE:-PathPrefix(`/`)}"
      - "traefik.http.routers.drone-server.entrypoints=websecure"
      - "traefik.http.routers.drone-server.tls=true"
      - "traefik.http.routers.drone-server.tls.certresolver=letsencrypt"
      - "traefik.http.services.drone-server.loadbalancer.server.port=80"
      
      # Apply middlewares for compression, security, and body size
      - "traefik.http.routers.drone-server.middlewares=security-headers-drone@file,compression-drone@file,body-size-drone@file"

  # ==========================================================================
  # Drone Runner - Docker-based Pipeline Executor
  # ==========================================================================
  drone-runner:
    image: drone/drone-runner-docker:1
    container_name: drone-runner
    restart: unless-stopped
    env_file:
      - .env.drone
    environment:
      # Runner Configuration
      - DRONE_RPC_PROTO=${DRONE_SERVER_PROTO:-http}
      - DRONE_RPC_HOST=drone-server
      
      # Runner Capacity
      - DRONE_RUNNER_CAPACITY=${DRONE_RUNNER_CAPACITY:-2}
      - DRONE_RUNNER_NAME=${DRONE_RUNNER_NAME:-docker-runner}
      
      # Docker Configuration
      - DRONE_RUNNER_NETWORKS=drone-network
      
      # Optional: Logs
      - DRONE_DEBUG=${DRONE_DEBUG:-false}
      - DRONE_TRACE=${DRONE_TRACE:-false}
    volumes:
      # Mount Docker socket to allow runner to create containers
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      drone-server:
        condition: service_healthy
    networks:
      - drone-network
    # Runner doesn't expose ports - communicates with server via RPC

  # ==========================================================================
  # PostgreSQL Database for Drone
  # ==========================================================================
  drone-db:
    image: postgres:15-alpine
    container_name: drone-db
    restart: unless-stopped
    env_file:
      - .env.drone
    environment:
      - POSTGRES_USER=${DRONE_POSTGRES_USER:-drone}
      - POSTGRES_PASSWORD=${DRONE_POSTGRES_PASSWORD}
      - POSTGRES_DB=${DRONE_POSTGRES_DB:-drone}
    volumes:
      - drone-postgres-data:/var/lib/postgresql/data
    networks:
      - drone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DRONE_POSTGRES_USER:-drone}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  # Separate network for Drone CI
  # NoteHub uses 'notehub-network', so no conflicts
  drone-network:
    driver: bridge

volumes:
  drone-data:
    driver: local
  drone-postgres-data:
    driver: local
