# =============================================================================
# Docker Compose for NoteHub - Database Replication Setup with Traefik
# =============================================================================
#
# This file demonstrates database replication configuration for NoteHub.
# It includes examples for both MySQL replication and SQLite replication.
#
# IMPORTANT: This is an example configuration for testing and development.
# For production, use a managed database service with built-in replication
# (e.g., AWS RDS, Google Cloud SQL, Azure Database) or set up replication
# according to your infrastructure requirements.
#
# Usage:
#   1. Copy .env.example to .env and configure replication settings
#   2. Start with MySQL replication:
#      docker compose -f docker-compose.replication.yml --profile mysql-replication up -d
#   3. Start with SQLite replication (using Litestream):
#      docker compose -f docker-compose.replication.yml --profile sqlite-replication up -d
#
# Services:
#   - traefik: Reverse proxy and load balancer (port 80)
#   - mysql-primary: Primary MySQL server (writes + reads)
#   - mysql-replica-1: First MySQL replica (reads only)
#   - mysql-replica-2: Second MySQL replica (reads only)
#   - litestream: Continuous SQLite replication to S3 or local storage
#
# =============================================================================

services:
  # ==========================================================================
  # Traefik - Reverse Proxy (MySQL Replication) with SSL/HTTPS
  # ==========================================================================
  traefik-mysql-replication:
    image: traefik:v2.11
    container_name: notehub-traefik-mysql-replication
    restart: unless-stopped
    profiles:
      - mysql-replication
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=notehub-network"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--ping=true"
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/dynamic.yml:/etc/traefik/dynamic/dynamic.yml:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Traefik - Reverse Proxy (SQLite Replication) with SSL/HTTPS
  # ==========================================================================
  traefik-sqlite-replication:
    image: traefik:v2.11
    container_name: notehub-traefik-sqlite-replication
    restart: unless-stopped
    profiles:
      - sqlite-replication
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=notehub-network"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--ping=true"
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/dynamic.yml:/etc/traefik/dynamic/dynamic.yml:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
  # ==========================================================================
  # MySQL Primary Database
  # ==========================================================================
  mysql-primary:
    image: mysql:8.0
    container_name: notehub-mysql-primary
    restart: unless-stopped
    profiles:
      - mysql-replication
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
    command: >
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=ROW
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --binlog-do-db=notehub
    volumes:
      - mysql-primary-data:/var/lib/mysql
      - ./docker/mysql/init-primary.sql:/docker-entrypoint-initdb.d/init-primary.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Replica 1
  # ==========================================================================
  mysql-replica-1:
    image: mysql:8.0
    container_name: notehub-mysql-replica-1
    restart: unless-stopped
    profiles:
      - mysql-replication
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
    command: >
      --server-id=2
      --log-bin=mysql-bin
      --binlog-format=ROW
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --relay-log=relay-bin
      --read-only=ON
      --skip-slave-start
    volumes:
      - mysql-replica-1-data:/var/lib/mysql
      - ./docker/mysql/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro
    depends_on:
      mysql-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # MySQL Replica 2
  # ==========================================================================
  mysql-replica-2:
    image: mysql:8.0
    container_name: notehub-mysql-replica-2
    restart: unless-stopped
    profiles:
      - mysql-replication
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
    command: >
      --server-id=3
      --log-bin=mysql-bin
      --binlog-format=ROW
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --relay-log=relay-bin
      --read-only=ON
      --skip-slave-start
    volumes:
      - mysql-replica-2-data:/var/lib/mysql
      - ./docker/mysql/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro
    depends_on:
      mysql-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - notehub-network

  # ==========================================================================
  # Backend with MySQL Replication
  # ==========================================================================
  backend-mysql-replication:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-mysql-replication
    restart: unless-stopped
    profiles:
      - mysql-replication
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}
      
      # Primary MySQL connection
      - MYSQL_HOST=mysql-primary
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-notehub}
      
      # Enable replication
      - DB_REPLICATION_ENABLED=true
      - MYSQL_REPLICA_HOSTS=mysql-replica-1,mysql-replica-2
      - MYSQL_REPLICA_PORTS=3306,3306
      - MYSQL_REPLICA_USER=${MYSQL_USER:?Set MYSQL_USER in .env file}
      - MYSQL_REPLICA_PASSWORD=${MYSQL_PASSWORD:?Set MYSQL_PASSWORD in .env file}
    volumes:
      - notehub-uploads:/app/uploads
    depends_on:
      mysql-primary:
        condition: service_healthy
      mysql-replica-1:
        condition: service_healthy
      mysql-replica-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - notehub-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-mysql-repl-api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.backend-mysql-repl-api.entrypoints=websecure"
      - "traefik.http.routers.backend-mysql-repl-api.priority=10"
      - "traefik.http.routers.backend-mysql-repl-api.tls=true"
      - "traefik.http.routers.backend-mysql-repl-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-mysql-repl-api.loadbalancer.server.port=5000"
      - "traefik.http.routers.backend-mysql-repl-uploads.rule=PathPrefix(`/uploads`)"
      - "traefik.http.routers.backend-mysql-repl-uploads.entrypoints=websecure"
      - "traefik.http.routers.backend-mysql-repl-uploads.priority=10"
      - "traefik.http.routers.backend-mysql-repl-uploads.tls=true"
      - "traefik.http.routers.backend-mysql-repl-uploads.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-mysql-repl-uploads.loadbalancer.server.port=5000"
      - "traefik.http.routers.backend-mysql-repl-health.rule=Path(`/health`)"
      - "traefik.http.routers.backend-mysql-repl-health.entrypoints=websecure"
      - "traefik.http.routers.backend-mysql-repl-health.priority=10"
      - "traefik.http.routers.backend-mysql-repl-health.tls=true"
      - "traefik.http.routers.backend-mysql-repl-health.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-mysql-repl-health.loadbalancer.server.port=5000"

  # ==========================================================================
  # Frontend with MySQL Replication Backend
  # ==========================================================================
  frontend-mysql-replication:
    build:
      context: .
      dockerfile: Dockerfile.frontend.traefik
      args:
        - VITE_API_URL=
    container_name: notehub-frontend-mysql-replication
    restart: unless-stopped
    profiles:
      - mysql-replication
    env_file:
      - .env
    depends_on:
      backend-mysql-replication:
        condition: service_healthy
      traefik-mysql-replication:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-mysql-repl.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend-mysql-repl.entrypoints=websecure"
      - "traefik.http.routers.frontend-mysql-repl.priority=1"
      - "traefik.http.routers.frontend-mysql-repl.tls=true"
      - "traefik.http.routers.frontend-mysql-repl.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend-mysql-repl.loadbalancer.server.port=80"
      - "traefik.http.routers.frontend-mysql-repl.middlewares=security-headers@file,compression@file"

  # ==========================================================================
  # Litestream for SQLite Replication
  # ==========================================================================
  # Litestream continuously backs up SQLite to S3 or local storage
  # See: https://litestream.io/
  litestream:
    image: litestream/litestream:latest
    container_name: notehub-litestream
    restart: unless-stopped
    profiles:
      - sqlite-replication
    env_file:
      - .env
    environment:
      # Configure Litestream destination (S3, local, etc.)
      - LITESTREAM_ACCESS_KEY_ID=${LITESTREAM_ACCESS_KEY_ID:-}
      - LITESTREAM_SECRET_ACCESS_KEY=${LITESTREAM_SECRET_ACCESS_KEY:-}
      - LITESTREAM_S3_BUCKET=${LITESTREAM_S3_BUCKET:-}
      - LITESTREAM_S3_REGION=${LITESTREAM_S3_REGION:-us-east-1}
    volumes:
      - notehub-data:/data
      - ./docker/litestream/litestream.yml:/etc/litestream.yml:ro
    command: replicate
    networks:
      - notehub-network

  # ==========================================================================
  # Backend with SQLite Replication (using Litestream)
  # ==========================================================================
  backend-sqlite-replication:
    build:
      context: .
      dockerfile: Dockerfile.backend.node
    container_name: notehub-backend-sqlite-replication
    restart: unless-stopped
    profiles:
      - sqlite-replication
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - JWT_SECRET=${SECRET_KEY:-change-me-in-production}
      - PORT=5000
      - NOTES_ADMIN_USERNAME=${NOTES_ADMIN_USERNAME:-admin}
      - NOTES_ADMIN_PASSWORD=${NOTES_ADMIN_PASSWORD:?Set NOTES_ADMIN_PASSWORD in .env file}
      
      # SQLite configuration
      - NOTES_DB_PATH=/app/data/notes.db
      
      # Enable SQLite replication (replicas created by Litestream)
      - DB_REPLICATION_ENABLED=true
      - SQLITE_REPLICA_PATHS=/app/data/notes-replica1.db,/app/data/notes-replica2.db
    volumes:
      - notehub-data:/app/data
      - notehub-uploads:/app/uploads
    depends_on:
      - litestream
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - notehub-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-sqlite-repl-api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.backend-sqlite-repl-api.entrypoints=websecure"
      - "traefik.http.routers.backend-sqlite-repl-api.priority=10"
      - "traefik.http.routers.backend-sqlite-repl-api.tls=true"
      - "traefik.http.routers.backend-sqlite-repl-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-sqlite-repl-api.loadbalancer.server.port=5000"
      - "traefik.http.routers.backend-sqlite-repl-uploads.rule=PathPrefix(`/uploads`)"
      - "traefik.http.routers.backend-sqlite-repl-uploads.entrypoints=websecure"
      - "traefik.http.routers.backend-sqlite-repl-uploads.priority=10"
      - "traefik.http.routers.backend-sqlite-repl-uploads.tls=true"
      - "traefik.http.routers.backend-sqlite-repl-uploads.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-sqlite-repl-uploads.loadbalancer.server.port=5000"
      - "traefik.http.routers.backend-sqlite-repl-health.rule=Path(`/health`)"
      - "traefik.http.routers.backend-sqlite-repl-health.entrypoints=websecure"
      - "traefik.http.routers.backend-sqlite-repl-health.priority=10"
      - "traefik.http.routers.backend-sqlite-repl-health.tls=true"
      - "traefik.http.routers.backend-sqlite-repl-health.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-sqlite-repl-health.loadbalancer.server.port=5000"

  # ==========================================================================
  # Frontend with SQLite Replication Backend
  # ==========================================================================
  frontend-sqlite-replication:
    build:
      context: .
      dockerfile: Dockerfile.frontend.traefik
      args:
        - VITE_API_URL=
    container_name: notehub-frontend-sqlite-replication
    restart: unless-stopped
    profiles:
      - sqlite-replication
    env_file:
      - .env
    depends_on:
      backend-sqlite-replication:
        condition: service_healthy
      traefik-sqlite-replication:
        condition: service_healthy
    networks:
      - notehub-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-sqlite-repl.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend-sqlite-repl.entrypoints=websecure"
      - "traefik.http.routers.frontend-sqlite-repl.priority=1"
      - "traefik.http.routers.frontend-sqlite-repl.tls=true"
      - "traefik.http.routers.frontend-sqlite-repl.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend-sqlite-repl.loadbalancer.server.port=80"
      - "traefik.http.routers.frontend-sqlite-repl.middlewares=security-headers@file,compression@file"

networks:
  notehub-network:
    driver: bridge

volumes:
  notehub-data:
    driver: local
  notehub-uploads:
    driver: local
  mysql-primary-data:
    driver: local
  mysql-replica-1-data:
    driver: local
  mysql-replica-2-data:
    driver: local
